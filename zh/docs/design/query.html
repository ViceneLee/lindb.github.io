<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Query | LinDB</title>
    <meta name="description" content="分布式时序数据库">
    <meta name="keywords" content="lindb tsdb">
  <link rel="shortcut icon" href="/images/logo.png">
  <link rel="stylesheet" type="text/css" href="//at.alicdn.com/t/font_1331329_he22yc3ekc6.css">
    
    <link rel="preload" href="/assets/css/0.styles.e395b7c9.css" as="style"><link rel="preload" href="/assets/js/app.627b6707.js" as="script"><link rel="preload" href="/assets/js/2.af743d84.js" as="script"><link rel="preload" href="/assets/js/5.259ddd00.js" as="script"><link rel="prefetch" href="/assets/js/10.3928823b.js"><link rel="prefetch" href="/assets/js/11.bea95668.js"><link rel="prefetch" href="/assets/js/12.51ea6530.js"><link rel="prefetch" href="/assets/js/13.852770cb.js"><link rel="prefetch" href="/assets/js/14.d3262a11.js"><link rel="prefetch" href="/assets/js/15.dba7f1d1.js"><link rel="prefetch" href="/assets/js/16.653a7f8c.js"><link rel="prefetch" href="/assets/js/17.12a162a3.js"><link rel="prefetch" href="/assets/js/18.64783d78.js"><link rel="prefetch" href="/assets/js/19.8934e34d.js"><link rel="prefetch" href="/assets/js/20.9dc6b153.js"><link rel="prefetch" href="/assets/js/21.ed723096.js"><link rel="prefetch" href="/assets/js/22.ee8a671b.js"><link rel="prefetch" href="/assets/js/23.5f4362a6.js"><link rel="prefetch" href="/assets/js/24.e611cea3.js"><link rel="prefetch" href="/assets/js/25.ec1005ac.js"><link rel="prefetch" href="/assets/js/26.ac078780.js"><link rel="prefetch" href="/assets/js/27.eb353606.js"><link rel="prefetch" href="/assets/js/28.b9626a77.js"><link rel="prefetch" href="/assets/js/29.9da98ac6.js"><link rel="prefetch" href="/assets/js/3.f501e063.js"><link rel="prefetch" href="/assets/js/30.026f8bd9.js"><link rel="prefetch" href="/assets/js/31.22351542.js"><link rel="prefetch" href="/assets/js/32.241cf97e.js"><link rel="prefetch" href="/assets/js/4.cc69c72d.js"><link rel="prefetch" href="/assets/js/6.f95d652a.js"><link rel="prefetch" href="/assets/js/7.082bf2d5.js"><link rel="prefetch" href="/assets/js/8.30ee74ad.js"><link rel="prefetch" href="/assets/js/9.bf71f016.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e395b7c9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/zh/" class="home-link router-link-active"><img src="/images/logo.png" alt="LinDB" class="logo"> <span class="site-name can-hide">LinDB</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/zh/docs/quick-start.html" class="nav-link">文档</a></div><div class="nav-item"><a href="/zh/docs/community/contributor-guide.html" class="nav-link">社区</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/design/query.html" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/zh/docs/design/query.html" class="nav-link router-link-exact-active router-link-active">简体中文</a></li></ul></div></div> <a href="https://github.com/lindb/lindb" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/zh/docs/quick-start.html" class="nav-link">文档</a></div><div class="nav-item"><a href="/zh/docs/community/contributor-guide.html" class="nav-link">社区</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">选择语言</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/design/query.html" class="nav-link">English</a></li><li class="dropdown-item"><!----> <a href="/zh/docs/design/query.html" class="nav-link router-link-exact-active router-link-active">简体中文</a></li></ul></div></div> <a href="https://github.com/lindb/lindb" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>概念</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zh/docs/concept/terminology.html" class="sidebar-link">术语</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>使用手册</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zh/docs/quick-start.html" class="sidebar-link">快速上手</a></li><li><a href="/zh/docs/example.html" class="sidebar-link">示例</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>设计文档</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/zh/docs/design/architecture.html" class="sidebar-link">Architecture</a></li><li><a href="/zh/docs/design/coordinator.html" class="sidebar-link">Coordinator</a></li><li><a href="/zh/docs/design/replication.html" class="sidebar-link">Replication</a></li><li><a href="/zh/docs/design/query.html" class="active sidebar-link">Query</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/zh/docs/design/query.html#overview" class="sidebar-link">Overview</a></li><li class="sidebar-sub-header"><a href="/zh/docs/design/query.html#simple-query" class="sidebar-link">Simple Query</a></li><li class="sidebar-sub-header"><a href="/zh/docs/design/query.html#complex-query" class="sidebar-link">Complex Query</a></li><li class="sidebar-sub-header"><a href="/zh/docs/design/query.html#cross-idc-query" class="sidebar-link">Cross IDC Query</a></li></ul></li><li><a href="/zh/docs/design/storage.html" class="sidebar-link">Storage</a></li><li><a href="/zh/docs/design/index_.html" class="sidebar-link">Index</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="query"><a href="#query" class="header-anchor">#</a> Query</h1> <h2 id="overview"><a href="#overview" class="header-anchor">#</a> Overview</h2> <p>参与查询的角色如下：</p> <ul><li>Broker: 接收用户的查询，根据查询语句生成相应的执行计划，并下发到相应的 Storage 节点，同时会聚合各 Storage 节点返回的结果，生成最终的结果</li> <li>Storage: 执行数据的过滤，Downsampling 和 最简单的原子计算（即有一定的算子下推的能力）</li></ul> <p>整个查询顺序如下，这里不分是在 Broker 还是 Storage 上执行，只看整个查询过程：</p> <ol><li>Query Language Plan</li> <li>Filtering</li> <li>Scan Time Series</li> <li>Grouping if need</li> <li>Downsampling</li> <li>Aggregation</li> <li>Functions</li> <li>Expressions</li></ol> <p>由于 LinDB 是用 Golang 实现，因此可以通过 Goroutine 就能很好的支持一个异步操作及高并发，但系统还是采用了 Goroutine Pool 的概念来处理这些异步 Task。</p> <p>整个查询过程都是异步完成，以异步 Task 的方式工作，即 Task A 只做一件事情，Task A 的结果可能是 Task B 的 Input，但是 Task B 不会等待 Task A 结果的到来，而是以 Event 的方式 Trigger Task B，最终完成一个查询 Pipeline 执行。</p> <p>这里需要特别说明的是，系统不会开几个 Goroutine 来完成一个请求，而是在不同的 Goroutine Pool 中完成，所有的 Task 都是没有返回值的，通过 Event 来 Trigger。</p> <p>下面举一个例子来说明，例如 Scan Goroutine Pool 只做 Scan 的操作，而不是启了一个 Goroutine Scan 数据，等待下一个 Task 结果再返回给上层 Task 来做合并，整个处理过程中各 Goroutine 还是会等待，而是直接把 Scan 的结果直接给下一个 Task，数据合并有专门的 Task 来完成，这样的好处是 Scan Goroutine 完成一个 Scan 操作之后，又可以做下一个 Scan 操作，可以更充分的利用系统资源。</p> <p>尽量通过 Streaming 的方式来完成整个查询过程，以减少没有必要的对象创建带来的 GC 压力，同时也会对一些可以复用并且高频的对象进行 Pool 化，以提升内存的使用率。</p> <p>根据不同的查询条件，可以 Plan 出如下几大类型的执行计划：</p> <ul><li>Simple Query: 简单的聚合查询；</li> <li>Complex Query: 带 Grouping 的查询；</li> <li>Cross IDC Query: 跨 IDC 之间的查询；</li></ul> <h2 id="simple-query"><a href="#simple-query" class="header-anchor">#</a> Simple Query</h2> <p><img src="/assets/img/simple_query.9e993e32.png" alt="simple query"></p> <ul><li>只做数据的过滤，Downsampling 及 Aggregation</li> <li>由于没有 Grouping 操作，因此最终的结果可以直接可以在 Root 节点进行聚合</li></ul> <h2 id="complex-query"><a href="#complex-query" class="header-anchor">#</a> Complex Query</h2> <p><img src="/assets/img/complex_query.64fbe945.png" alt="complex query"></p> <ul><li>由于在一些场景下面做 Grouping 再求 Top N 的时候，会返回大量的 Grouping 之后的数据，如果此时再把这些数据返回给一个计算节点的话，可能导致这个节点的内存成为瓶颈，因此引入了 Intermediate Broker 节点参与中间结果的计算</li> <li>执行计划会在当前可用的 Broker 节点中，挑选一些 Intermediate Broker 来参与计算</li> <li>Root 会把请求下发给 Intermediate Broker, 由 Intermediate Broker 再下发给个自对应的 Storage 节点</li> <li>Storage 会按 Grouping 之后 Series 的 hash 值，把数据 Sharding 的指定的 Intermediate Broker 节点上，这样可以做到同一个 Series 的数据可以 Sharding 到同一台 Intermediate Broker 上进行 Aggregation 操作</li> <li>最后每个 Intermediate Broker 节点把自己的计算结果返回给 Root 节点，Root 合并生成最终的结果</li></ul> <h2 id="cross-idc-query"><a href="#cross-idc-query" class="header-anchor">#</a> Cross IDC Query</h2> <p><img src="/assets/img/cross_idc_query.35730563.png" alt="cross idc query"></p> <ul><li>LinDB 的跨 IDC 是做在 Query 层，因此可以把此类查询理解为把上面 2 种查询下发到各 IDC 之后的再聚合操作</li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/lindb/lindb.github.io/edit/dev/docs/zh/docs/design/query.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">最后更新:</span> <span class="time">2019/10/22 上午9:07:28</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/zh/docs/design/replication.html" class="prev">Replication</a></span> <span class="next"><a href="/zh/docs/design/storage.html">Storage</a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.627b6707.js" defer></script><script src="/assets/js/2.af743d84.js" defer></script><script src="/assets/js/5.259ddd00.js" defer></script>
  </body>
</html>
