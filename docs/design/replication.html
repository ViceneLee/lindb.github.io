<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Replication | LinDB</title>
    <meta name="description" content="A distributed time series database">
    <meta name="keywords" content="lindb tsdb">
  <link rel="shortcut icon" href="/images/logo.png">
  <link rel="stylesheet" type="text/css" href="//at.alicdn.com/t/font_1331329_he22yc3ekc6.css">
    
    <link rel="preload" href="/assets/css/0.styles.e395b7c9.css" as="style"><link rel="preload" href="/assets/js/app.cbcaf32e.js" as="script"><link rel="preload" href="/assets/js/2.f95aede0.js" as="script"><link rel="preload" href="/assets/js/12.eee155d4.js" as="script"><link rel="prefetch" href="/assets/js/10.b3e297ea.js"><link rel="prefetch" href="/assets/js/11.a9344022.js"><link rel="prefetch" href="/assets/js/13.88c9dd65.js"><link rel="prefetch" href="/assets/js/14.79cc5049.js"><link rel="prefetch" href="/assets/js/15.57de3884.js"><link rel="prefetch" href="/assets/js/16.feca6a8a.js"><link rel="prefetch" href="/assets/js/17.426e7df3.js"><link rel="prefetch" href="/assets/js/18.4c1f7f4f.js"><link rel="prefetch" href="/assets/js/19.a4b615bd.js"><link rel="prefetch" href="/assets/js/20.30e1b91e.js"><link rel="prefetch" href="/assets/js/21.bd55e9ab.js"><link rel="prefetch" href="/assets/js/22.3ccb5656.js"><link rel="prefetch" href="/assets/js/23.1557d426.js"><link rel="prefetch" href="/assets/js/24.499ab2fe.js"><link rel="prefetch" href="/assets/js/25.3e88c41e.js"><link rel="prefetch" href="/assets/js/26.1d2f3010.js"><link rel="prefetch" href="/assets/js/27.8300129c.js"><link rel="prefetch" href="/assets/js/28.6b6fe83b.js"><link rel="prefetch" href="/assets/js/29.fcd6daa5.js"><link rel="prefetch" href="/assets/js/3.71688b73.js"><link rel="prefetch" href="/assets/js/30.a1e92e5c.js"><link rel="prefetch" href="/assets/js/31.cf301bbf.js"><link rel="prefetch" href="/assets/js/32.241cf97e.js"><link rel="prefetch" href="/assets/js/4.c5b6ce1e.js"><link rel="prefetch" href="/assets/js/5.5597e84b.js"><link rel="prefetch" href="/assets/js/6.9cbc92ec.js"><link rel="prefetch" href="/assets/js/7.3dc587d8.js"><link rel="prefetch" href="/assets/js/8.30ee74ad.js"><link rel="prefetch" href="/assets/js/9.25c749a7.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e395b7c9.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/images/logo.png" alt="LinDB" class="logo"> <span class="site-name can-hide">LinDB</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/quick-start.html" class="nav-link">Docs</a></div><div class="nav-item"><a href="/docs/community/contributor-guide.html" class="nav-link">Community</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/design/replication.html" class="nav-link router-link-exact-active router-link-active">English</a></li><li class="dropdown-item"><!----> <a href="/zh/docs/design/replication.html" class="nav-link">简体中文</a></li></ul></div></div> <a href="https://github.com/lindb/lindb" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/quick-start.html" class="nav-link">Docs</a></div><div class="nav-item"><a href="/docs/community/contributor-guide.html" class="nav-link">Community</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/design/replication.html" class="nav-link router-link-exact-active router-link-active">English</a></li><li class="dropdown-item"><!----> <a href="/zh/docs/design/replication.html" class="nav-link">简体中文</a></li></ul></div></div> <a href="https://github.com/lindb/lindb" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Concept</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/concept/terminology.html" class="sidebar-link">Terminology</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>User Guide</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/quick-start.html" class="sidebar-link">Quick Start</a></li><li><a href="/docs/example.html" class="sidebar-link">Example</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Design</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/docs/design/architecture.html" class="sidebar-link">Architecture</a></li><li><a href="/docs/design/coordinator.html" class="sidebar-link">Coordinator</a></li><li><a href="/docs/design/replication.html" class="active sidebar-link">Replication</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/docs/design/query.html" class="sidebar-link">Query</a></li><li><a href="/docs/design/storage.html" class="sidebar-link">Storage</a></li><li><a href="/docs/design/index_.html" class="sidebar-link">Index</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="replication"><a href="#replication" class="header-anchor">#</a> Replication</h1> <p>client通过tcp或http协议将时序数据(包含database, metric name, tags, timestamp, fields信息)发送到broker，broker首先判断database是否存在，如果存在根据metric name，tags及database配置的shard总数计算所属的shard，然后将数据写入到shard相应内存buffer中，当buffer大小超过限制或离上一次写入时间超过限制，内存buffer中的数据会作为一条record追加到当前shard所属的磁盘日志文件中。</p> <p>一个shard依据配置的备份数会对应一个或多个物理的storage节点，broker查询etcd中数据了解到这些信息，通过rpc将shard日志文件中record有序的复制到对应的storage节点。依据目前的设计，storage直接将record数据写入到内存中，不会再额外写wal。等内存中数据写入磁盘后，通过rpc通知broker这部分数据已经完全消费。broker等所有storage节点完成确认后删除磁盘文件。</p> <p>一个shard的复制过程可以抽象为Fanout queue的生产和消费过程，实现时借鉴了<a href="https://github.com/bulldog2011/bigqueue" target="_blank" rel="noopener noreferrer">bigqueue<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，broker将写入的数据计算shard，累计成批后写入Fanout queue，异步go routine负责将数据推送到对应的storage节点，storage确认成功消费的数据记录。broker删除被所有消费者acked的queue文件。</p> <p><img src="/assets/img/replication.ec21c7de.png" alt="replication"></p> <p>时序数据库对数据写入的顺序没有要求，只要数据最终都完成写入，查询的结果是一致的，broker向storage复制时保持顺序性是为了依靠顺序性处理各种异常场景，保证数据准确地复制到storage。</p> <h3 id="broker"><a href="#broker" class="header-anchor">#</a> broker</h3> <ol><li>broker询问storage消费record的index，如果index有效(未超过broker当前写入的head index，大于broker已经acked的tail index)，进入第3步，否则进入第2步</li> <li>以broker记录的index重置storage的index，进入第3步</li> <li>从index开始复制数据到storage，如果出现异常回到第1步</li></ol> <h3 id="storage"><a href="#storage" class="header-anchor">#</a> storage</h3> <ol><li>响应broker查询，重置record index请求</li> <li>接收broker复制推送的record，检测record的index和storage记录的index是否一致，一致则返回ok，index自增1，否则返回错误</li></ol> <p>TBD</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/lindb/lindb.github.io/edit/dev/docs/docs/design/replication.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">10/24/2019, 3:19:17 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/docs/design/coordinator.html" class="prev">Coordinator</a></span> <span class="next"><a href="/docs/design/query.html">Query</a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.cbcaf32e.js" defer></script><script src="/assets/js/2.f95aede0.js" defer></script><script src="/assets/js/12.eee155d4.js" defer></script>
  </body>
</html>
